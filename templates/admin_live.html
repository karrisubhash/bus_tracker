<!DOCTYPE html>
<html>
<head>
  <title>Admin ‚Äì Live Bus Monitoring</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Leaflet Routing Machine -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css">
  <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

  <style>
    body { margin: 0; font-family: Arial; }
    header {
      background: #0f172a;
      color: white;
      padding: 12px 18px;
      font-size: 18px;
      font-weight: bold;
    }
    #map { height: calc(100vh - 50px); }
  </style>
</head>
<body>

<header>üõ† Admin Live Bus Monitoring</header>
<div id="map"></div>
<script>

/* ================= CONSTANTS ================= */

const COLLEGE = L.latLng(17.91925, 83.42445);
const STOP = L.latLng(17.91984, 83.41716);

const token = localStorage.getItem("admin_token");

if (!token) {
  alert("Admin login required");
  window.location.href = "/admin/login/";
}

/* ================= MAP ================= */

const map = L.map("map").setView([17.91925, 83.42445], 12);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  attribution: "¬© OpenStreetMap"
}).addTo(map);

/* ================= ICON ================= */

function createBusIcon(heading = 0, hasIssue = false) {
  const iconUrl = hasIssue
    ? "https://cdn-icons-png.flaticon.com/512/3205/3205237.png"
    : "https://cdn-icons-png.flaticon.com/512/174/174237.png";

  return L.divIcon({
    className: "",
    html: `
      <div style="
        transform: rotate(${heading}deg);
        transition: transform 0.3s linear;
      ">
        <img src="${iconUrl}" width="40"/>
      </div>
    `,
    iconSize: [32, 32],
    iconAnchor: [16, 16],
  });
}

/* ================= STATE ================= */

const markers = {};
const routeControls = {};
const previousPositions = {};
const lastUpdateTime = {};

let firstLoad = true;

/* ================= SMOOTH MOVE ================= */

function animateMarker(marker, from, to) {
  const duration = 4000;
  const start = performance.now();

  function animate(time) {
    const progress = Math.min((time - start) / duration, 1);

    const lat = from.lat + (to.lat - from.lat) * progress;
    const lng = from.lng + (to.lng - from.lng) * progress;

    marker.setLatLng([lat, lng]);

    if (progress < 1) {
      requestAnimationFrame(animate);
    }
  }

  requestAnimationFrame(animate);
}

/* ================= REMOVE INACTIVE BUSES ================= */

function cleanupInactiveBuses() {
  const now = Date.now();

  Object.keys(lastUpdateTime).forEach(tripId => {
    if (now - lastUpdateTime[tripId] > 15000) {
      // No update for 15 seconds ‚Üí remove

      if (markers[tripId]) {
        map.removeLayer(markers[tripId]);
        delete markers[tripId];
      }

      if (routeControls[tripId]) {
        map.removeControl(routeControls[tripId]);
        delete routeControls[tripId];
      }

      delete previousPositions[tripId];
      delete lastUpdateTime[tripId];
    }
  });
}

/* ================= LOAD LIVE BUSES ================= */

async function loadLiveBuses() {
  try {
    const res = await fetch("/api/admin/live-locations/", {
      headers: { Authorization: "Bearer " + token }
    });

    if (!res.ok) return;

    const buses = await res.json();
    if (!Array.isArray(buses)) return;

    const bounds = L.latLngBounds();

    buses.forEach(bus => {
      const tripId = bus.trip_id;
      const newPos = L.latLng(bus.lat, bus.lon);
      const heading = bus.heading || 0;

      lastUpdateTime[tripId] = Date.now();

      if (!markers[tripId]) {

        /* Create marker first time */
        markers[tripId] = L.marker(newPos, {
          icon: createBusIcon(heading, bus.has_issue)
        })
        .addTo(map)
        .bindPopup(`
          <b>üöå Bus:</b> ${bus.bus}<br>
          <b>üõ£ Route:</b> ${bus.route}<br>
          <b>üë®‚Äç‚úà Driver:</b> ${bus.driver}
        `);

        previousPositions[tripId] = newPos;

        /* Create route only once */
        routeControls[tripId] = L.Routing.control({
          waypoints: [newPos, STOP, COLLEGE],
          router: L.Routing.osrmv1({
            serviceUrl: "https://router.project-osrm.org/route/v1"
          }),
          lineOptions: {
            styles: [{ color: "#2563eb", weight: 5 }]
          },
          addWaypoints: false,
          draggableWaypoints: false,
          fitSelectedRoutes: false,
          show: false,
          createMarker: () => null
        }).addTo(map);

      } else {

        /* Smooth animation */
        animateMarker(markers[tripId], previousPositions[tripId], newPos);

        markers[tripId].setIcon(
          createBusIcon(heading, bus.has_issue)
        );

        previousPositions[tripId] = newPos;

        routeControls[tripId].setWaypoints([newPos, STOP, COLLEGE]);
      }

      bounds.extend(newPos);
      bounds.extend(COLLEGE);
    });

    cleanupInactiveBuses();

    if (firstLoad) {
      map.fitBounds(bounds, { padding: [50, 50] });
      firstLoad = false;
    }

  } catch (err) {
    console.error("Live map error:", err);
  }
}

/* ================= START REFRESH SYSTEM ================= */

loadLiveBuses();
setInterval(loadLiveBuses, 4000);
setInterval(cleanupInactiveBuses, 5000);

</script>
</body>
</html>
