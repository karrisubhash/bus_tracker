<!DOCTYPE html>
<html>
<head>
  <title>Admin â€“ Live Bus Monitoring</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Leaflet Routing Machine -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css">
  <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

  <style>
    body { margin: 0; font-family: Arial; }
    header {
      background: #0f172a;
      color: white;
      padding: 12px 18px;
      font-size: 18px;
      font-weight: bold;
    }
    #map { height: calc(100vh - 50px); }
  </style>
</head>
<body>

<header>ğŸ›  Admin Live Bus Monitoring</header>
<div id="map"></div>

<script>

/* ================= CONSTANTS ================= */

// ğŸ“ College fixed location
const COLLEGE = L.latLng(17.91925, 83.42445);
const STOP = L.latLng(17.91984, 83.41716);
//const STOPs = L.latLng(17.72364, 83.30540);


/* ================= AUTH ================= */

const token = localStorage.getItem("admin_token");
console.log("ADMIN TOKEN:", token);

if (!token) {
  alert("Admin login required");
  window.location.href = "/admin/login/";
}

/* ================= MAP ================= */

const map = L.map("map").setView([17.91925, 83.42445],9);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  attribution: "Â© OpenStreetMap"
}).addTo(map);

/* ================= ICONS ================= */

const normalIcon = L.icon({
  iconUrl: "https://cdn-icons-png.flaticon.com/512/174/174237.png",
  iconSize: [32, 32],
  iconAnchor: [16, 16],
});

const issueIcon = L.icon({
  iconUrl: "https://cdn-icons-png.flaticon.com/512/3205/3205237.png",
  iconSize: [32, 32],
  iconAnchor: [16, 16],
});

/* ================= STATE ================= */

const markers = {};         // trip_id -> marker
const routeControls = {};  // trip_id -> routing control
let firstLoad = true;

/* ================= LOAD LIVE BUSES ================= */

async function loadLiveBuses() {
  try {
    const res = await fetch("/api/admin/live-locations/", {
      headers: { Authorization: "Bearer " + token }
    });

    if (!res.ok) {
      console.error("API error:", res.status);
      return;
    }

    const buses = await res.json();
    console.log("Buses Received:", buses);

    if (!Array.isArray(buses) || buses.length === 0) return;

    const bounds = L.latLngBounds();

    buses.forEach(bus => {
      const tripId = bus.trip_id;
      const busPos = L.latLng(bus.lat, bus.lon);
      const icon = bus.has_issue ? issueIcon : normalIcon;

      /* ğŸšŒ Marker */
      if (!markers[tripId]) {
        markers[tripId] = L.marker(busPos, { icon })
          .addTo(map)
          .bindPopup(`
            <b>ğŸšŒ Bus:</b> ${bus.bus}<br>
            <b>ğŸ›£ Route:</b> ${bus.route}<br>
            <b>ğŸ‘¨â€âœˆ Driver:</b> ${bus.driver}<br>
          `);
      } else {
        markers[tripId].setLatLng(busPos).setIcon(icon);
      }

      /* ğŸ›£ Route: BUS â†’ COLLEGE */
      if (!routeControls[tripId]) {
        routeControls[tripId] = L.Routing.control({
          waypoints: [busPos,STOP, COLLEGE],
          router: L.Routing.osrmv1({
            serviceUrl: "https://router.project-osrm.org/route/v1"
          }),
          lineOptions: {
            styles: [{ color: "#2563eb", weight: 5 }]
          },
          addWaypoints: false,
          draggableWaypoints: false,
          fitSelectedRoutes: false,
          show: false,
          createMarker: () => null   // hide routing markers
        }).addTo(map);
      } else {
        routeControls[tripId].setWaypoints([busPos,STOP,COLLEGE]);
      }

      bounds.extend(busPos);
      bounds.extend(COLLEGE);
    });

    /* ğŸ” Auto zoom only once */
    if (firstLoad) {
      map.fitBounds(bounds, { padding: [50, 50] });
      firstLoad = false;
    }

  } catch (err) {
    console.error("Live map error:", err);
  }
}

/* ================= START ================= */

loadLiveBuses();
setInterval(loadLiveBuses, 5000);
</script>

</body>
</html>
